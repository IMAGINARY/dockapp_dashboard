{"version":3,"sources":["lib/test-backend/test-backend.js"],"names":["TestBackend","nconf","logger","simulateDelays","hilbertCLIConnector","mkLivestatusConnector","hilbertCfg","state","Map","station_cfg","Object","entries","Stations","stationID","stationData","addStation","id","stationCfg","set","name","description","profile","type","default_app","client_settings","hilbert_station_default_application","compatible_apps","compatible_applications","initStationState","HostState","DOWN","state_type","StateType","HARD","app_state","ServiceState","UNKNOWN","app_state_type","app_id","answer","toStopUnexpectedly","get","unreachable","values","stationState","newState","assign","includes","UNREACHABLE","push","output","Promise","resolve","write","randomDelay","then","reject","Error","UP","OK","appID","indexOf","min","max","delay","Math","floor","random","setTimeout"],"mappings":"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","file":"lib/test-backend/test-backend.js","sourcesContent":["import Nagios from '../nagios';\nimport TestHilbertCLIConnector from './test-hilbert-cli-connector';\nimport TestMKLivestatusConnector from './test-mk-livestatus-connector';\n\nexport default class TestBackend {\n\n  constructor(nconf, logger) {\n    this.simulateDelays = false;\n    this.nconf = nconf;\n    this.logger = logger;\n\n    this.hilbertCLIConnector = new TestHilbertCLIConnector(this, nconf, logger);\n    this.mkLivestatusConnector = new TestMKLivestatusConnector(this, nconf, logger);\n\n    this.hilbertCfg = null;\n\n    this.state = new Map();\n    this.station_cfg = new Map();\n  }\n\n  /**\n   * Loads test data\n   *\n   * If any data was previously loaded it's overwritten.\n   *\n   * @param {Array} hilbertCfg An array of station configurations\n   */\n  load(hilbertCfg) {\n    this.hilbertCfg = hilbertCfg;\n\n    this.state = new Map();\n    this.station_cfg = new Map();\n\n    for (const [stationID, stationData] of Object.entries(hilbertCfg.Stations)) {\n      this.addStation(stationID, stationData);\n    }\n  }\n\n  /**\n   * Adds a station\n   *\n   * @param id ID of the station\n   * @param stationCfg Configuration of the station, taken from the configuration file\n   */\n  addStation(id, stationCfg) {\n    this.station_cfg.set(id, {\n      id,\n      name: stationCfg.name,\n      description: stationCfg.description,\n      profile: stationCfg.profile,\n      type: stationCfg.type,\n      default_app: stationCfg.client_settings.hilbert_station_default_application,\n      compatible_apps: stationCfg.compatible_applications,\n    });\n\n    this.initStationState(id);\n  }\n\n  /**\n   * Initializes the state of a station to the default (station down, app down)\n   *\n   * @param {String} id Station ID\n   */\n  initStationState(id) {\n    this.state.set(id, {\n      id,\n      state: Nagios.HostState.DOWN,\n      state_type: Nagios.StateType.HARD,\n      app_state: Nagios.ServiceState.UNKNOWN,\n      app_state_type: Nagios.StateType.HARD,\n      app_id: '',\n    });\n  }\n\n  /**\n   * Returns a HilbertCLIConnector stub for testing\n   * @returns {TestHilbertCLIConnector}\n   */\n  getHilbertCLIConnector() {\n    return this.hilbertCLIConnector;\n  }\n\n  /**\n   * Returns a MKLivestatusConnector stub for testing\n   * @returns {TestMKLivestatusConnector}\n   */\n  getMKLivestatusConnector() {\n    return this.mkLivestatusConnector;\n  }\n\n  getStationState() {\n    const answer = [];\n\n    const toStopUnexpectedly = this.nconf.get('test-backend:stop-unexpectedly') || [];\n    const unreachable = this.nconf.get('test-backend:unreachable') || [];\n    for (const stationState of this.state.values()) {\n      const newState = Object.assign({}, stationState);\n\n      if (toStopUnexpectedly.includes(stationState.id)) {\n        newState.state = Nagios.HostState.DOWN;\n        // This new state overrides the internal state\n        this.state.set(stationState.id, newState);\n      }\n      if (unreachable.includes(stationState.id)) {\n        newState.state = Nagios.HostState.UNREACHABLE;\n        // This new state is does not override the internal state\n      }\n\n      answer.push(newState);\n    }\n\n    return answer;\n  }\n\n  /**\n   * Reads the station config\n   * @returns {Promise}\n   * @resolve {Array} - List of stations\n   * @reject {Error}\n   */\n  getHilbertCfg(output) {\n    return new Promise((resolve) => {\n      output.write('Simulating reading hilbert configuration. Waiting a random delay...');\n      this.randomDelay(1000, 3000).then(() => {\n        output.write('Wait finished.');\n        resolve(this.hilbertCfg);\n      });\n    });\n  }\n\n  /**\n   * Starts a station\n   *\n   * @param stationID\n   * @param {Writable} output - Command output should be written here\n   * @returns {Promise}\n   */\n  startStation(stationID, output) {\n    if (this.nconf.get('test-backend:sim-fail-cli') === true) {\n      return Promise.reject(new Error('Simulated Hilbert CLI failure'));\n    }\n\n    return new Promise((resolve) => {\n      if (this.nconf.get('test-backend:sim-timeout') === true) {\n        output.write(`Simulating starting station ${stationID} with operation that times out.`);\n        return Promise.resolve();\n      }\n\n      output.write(`Simulating starting station ${stationID}. Waiting a random delay...`);\n      this.randomDelay(3000, 8000).then(() => {\n        output.write('Wait finished.');\n        const stationState = this.state.get(stationID);\n        const stationCfg = this.station_cfg.get(stationID);\n        if (stationState &&\n          (stationState.state === Nagios.HostState.DOWN)) {\n          stationState.state = Nagios.HostState.UP;\n          stationState.app_state = Nagios.ServiceState.OK;\n          stationState.app_state_type = Nagios.StateType.HARD;\n          stationState.app_id = stationCfg.default_app;\n          output.write(`Station state set to UP with app ${stationState.app_id}.`);\n        }\n      }).then(resolve);\n    });\n  }\n\n  /**\n   * Stops a station\n   *\n   * @param stationID\n   * @param {Writable} output - Command output should be written here\n   * @returns {Promise}\n   */\n  stopStation(stationID, output) {\n    if (this.nconf.get('test-backend:sim-fail-cli') === true) {\n      return Promise.reject(new Error('Simulated Hilbert CLI failure'));\n    }\n\n    return new Promise((resolve) => {\n      if (this.nconf.get('test-backend:sim-timeout') === true) {\n        output.write(`Simulating stopping station ${stationID} with operation that times out.`);\n        return Promise.resolve();\n      }\n\n      output.write(`Simulating stopping station ${stationID}. Waiting a random delay...`);\n      this.randomDelay(2000, 6000).then(() => {\n        output.write('Wait finished.');\n        const stationState = this.state.get(stationID);\n        if (stationState && (stationState.state === Nagios.HostState.UP)) {\n          stationState.state = Nagios.HostState.DOWN;\n          stationState.app_state = Nagios.ServiceState.UNKNOWN;\n          stationState.app_state_type = Nagios.StateType.HARD;\n          stationState.app_id = '';\n          output.write('Station state set to DOWN.');\n        }\n      }).then(resolve);\n    });\n  }\n\n  /**\n   * Change the foreground application running in a station\n   *\n   * @param {string} stationID - ID of the station\n   * @param {string} appID - ID of the app to set\n   * @param {Writable} output - Command output should be written here\n   * @returns {Promise}\n   */\n  changeApp(stationID, appID, output) {\n    if (this.nconf.get('test-backend:sim-fail-cli') === true) {\n      return Promise.reject(new Error('Simulated Hilbert CLI failure'));\n    }\n\n    return new Promise((resolve, reject) => {\n      if (this.nconf.get('test-backend:sim-timeout') === true) {\n        output.write(`Simulating changing app for station ${stationID} to ${appID} with operation that times out.`);\n        return Promise.resolve();\n      }\n\n      output.write(\n        `Simulating changing app for station ${stationID} to ${appID}. Waiting a random delay...`);\n      this.randomDelay(1000, 5000).then(() => {\n        output.write('Wait finished.');\n        const stationState = this.state.get(stationID);\n        const stationCfg = this.station_cfg.get(stationID);\n\n        if (stationCfg.compatible_apps.indexOf(appID) >= 0) {\n          stationState.app_id = appID;\n          output.write('App changed.');\n        }\n      }).then(() => {\n        if (appID === 'Sky explorer / Aladin lite') {\n          output.write('Simulating failure when changing app to Sky explorer');\n          reject();\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  /**\n   * Wait a random amount of time\n   * @private\n   * @param min\n   * @param max\n   * @returns {Promise}\n   */\n  randomDelay(min, max) {\n    if (this.simulateDelays) {\n      return new Promise((resolve) => {\n        const delay = Math.floor(Math.random() * (max - min)) + min;\n        setTimeout(() => {\n          resolve();\n        }, delay);\n      });\n    }\n\n    return Promise.resolve();\n  }\n}\n"],"sourceRoot":"/source/"}