{"version":3,"sources":["lib/mk-livestatus-connector.js"],"names":[],"mappings":"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","file":"lib/mk-livestatus-connector.js","sourcesContent":["const Promise = require('bluebird');\nimport { exec } from 'child_process';\nimport MKLivestatusQuery from './mk-livestatus-query';\n\n/**\n * Connects to the MK Livestatus service and\n * retrieves status data\n *\n * http://mathias-kettner.com/checkmk_livestatus.html\n */\nexport default class MKLivestatusConnector {\n\n  constructor(nconf, logger) {\n    this.nconf = nconf;\n    this.logger = logger;\n  }\n\n  /**\n   * Returns the state of the stations\n   * Returns an array of objects with shape\n   * {id: 'station name', state: 0, state_type: 1,\n   * app_state: 0, app_state_type: 1, app_id: 'fg app name'}\n   *\n   * @returns {Promise}\n   * @resolve {Array}\n   */\n  getState() {\n    this.logger.debug('MKLivestatus: Querying');\n    const state = new Map();\n    return this.getStationState()\n      .then((stations) => {\n        this.logger.debug('MKLivestatus: host state response received. Updating stations.');\n        for (const station of stations) {\n          if (station.hasOwnProperty('id')) {\n            state.set(station.id, station);\n          }\n        }\n        return this.getForegroundApps();\n      })\n      .then((stations) => {\n        this.logger.debug('MKLivestatus: app state response received. Updating stations.');\n        for (const station of stations) {\n          if (station.hasOwnProperty('id') &&\n              state.has(station.id)) {\n            const stationState = state.get(station.id);\n            stationState.app_state = station.app_state;\n            stationState.app_state_type = station.app_state_type;\n            stationState.app_id = station.app_id;\n          }\n        }\n\n        return state.values();\n      })\n      .catch((err) => {\n        this.logger.error(`MKLivestatus: Error querying '${err.message}'`);\n        throw err;\n      });\n  }\n\n  /**\n   * Queries the state of the stations\n   * Returns an array of objects with shape\n   * {id: 'station name ', state: 0, state_type: 1}\n   * @private\n   *\n   * @returns {Promise}\n   * @resolve {Array}\n   * @reject {Error}\n   */\n  getStationState() {\n    this.logger.debug('MKLivestatus: Querying host state');\n    return this.query()\n      .get('hosts')\n      .columns(['name', 'state', 'state_type'])\n      .asColumns(['id', 'state', 'state_type'])\n      .execute();\n  }\n\n  /**\n   * Queries the foreground apps running in the stations\n   * Returns an array of objects with shape\n   * {id: 'station name', app_state: 0, app_state_type: 1, app_id: 'app name'}\n   * @private\n   *\n   * @returns {Promise}\n   */\n  getForegroundApps() {\n    this.logger.debug('MKLivestatus: Querying app state');\n    return this.query()\n      .get('services')\n      .columns(['host_name', 'state', 'state_type', 'plugin_output'])\n      .asColumns(['id', 'app_state', 'app_state_type', 'app_id'])\n      .filter('description = dockapp_top1')\n      .execute()\n      .then((stations) => {\n        for (const station of stations) {\n          // todo: replace for better regexp / parsing\n          const matches = station.app_id.match(/^[^:]+:\\s*(.*)@\\[.*\\]$/);\n          if (matches !== null && matches.hasOwnProperty('length') && matches.length > 1) {\n            station.app_id = matches[1];\n          } else {\n            if (station.app_id === 'CRIT - CRITICAL - no running TOP app!') {\n              station.app_id = '';\n            } else {\n              throw new Error(`Error parsing app_id of station ${station.id}: ${station.app_id}`);\n            }\n          }\n        }\n        return stations;\n      });\n  }\n\n  /**\n   * Creates a query\n   * @private\n   *\n   * @returns {MKLivestatusQuery}\n   */\n  query() {\n    return new MKLivestatusQuery(this);\n  }\n\n  /**\n   * Sends a query command to MKLivestatus\n   *\n   * @param {String} queryString\n   * @returns {Promise}\n   * @resolve {Array} Response rows\n   * @reject {Error}\n   */\n  sendCommand(queryString) {\n    return new Promise((resolve) => {\n      const MKLivestatusCommand = this.nconf.get('mkls_cmd');\n      this.logger.debug(`MKLivestatus: executing query through '${MKLivestatusCommand}'`);\n      this.logger.debug(`sending query '${queryString}'`);\n      const process = exec(MKLivestatusCommand);\n\n      let stdoutBuf = '';\n\n      process.stdout.on('data', (data) => {\n        stdoutBuf += data;\n      }).on('end', () => {\n        this.logger.debug(`MKLivestatus stdout: '${stdoutBuf}'`);\n        resolve(stdoutBuf);\n      });\n\n      process.stderr.on('data', (data) => {\n        this.logger.error(`MKLivestatus stderr: ${data}`);\n      });\n\n      process.stdin.end(`${queryString}\\n\\n`);\n    });\n  }\n}\n\n// When executed directly it performs a query\nif (require.main === module) {\n  const mkLivestatusConnector = new MKLivestatusConnector();\n  console.log('Querying');\n  mkLivestatusConnector.getState().then((state) => {\n    console.log(state);\n  });\n}\n"],"sourceRoot":"/source/"}