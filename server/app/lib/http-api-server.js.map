{"version":3,"sources":["lib/http-api-server.js"],"names":["EventEmitter","require","Promise","iconmap","express","validate","Joi","bodyParser","HttpAPIServer","stationManager","nconf","logger","server","use","json","events","notifications","apiModules","initializers","apiModule","push","init","all","then","setupRoutes","on","onNotification","bind","stationsLongPoll","get","signalUpdate","emit","router","Router","getApplications","getStationProfiles","getStations","post","postStationsStartSchema","postStationsStart","postStationsStopSchema","postStationsStop","postStationsChangeAppSchema","postStationsChangeApp","getStationOutputSchema","getStationOutput","getServerOutput","getServerMKLivestatus","getNotifications","moduleRouter","notification","updateID","getNextUpdateID","maxNotifications","length","slice","lastUpdateID","filter","n","req","res","applications","Array","from","map","a","toJSON","sort","b","name","stationProfiles","handleRequest","stations","s","station","icon","getIconURL","app","parseInt","query","getLatestNotifications","catch","body","ids","debug","status","send","startStations","stopStations","changeApp","params","id","getStationByID","lines","outputBuffer","getAll","error","globalHilbertCLIOutputBuffer","lastState","lastMKLivestatusDump","port","listen","info","appID","undefined","array","items","string","required"],"mappings":"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","file":"lib/http-api-server.js","sourcesContent":["import LongPollHandler from './long-poll-handler';\nimport PresetsModule from './presets/presets-module';\nimport TestControllerModule from './test-backend/test-controller-module';\n\nconst EventEmitter = require('events').EventEmitter;\nconst Promise = require('bluebird');\nconst iconmap = require('../../iconmap.json');\nconst express = require('express');\nconst validate = require('express-validation');\nconst Joi = require('joi');\nconst bodyParser = require('body-parser');\n\nexport default class HttpAPIServer {\n\n  constructor(stationManager, nconf, logger) {\n    this.stationManager = stationManager;\n    this.nconf = nconf;\n    this.logger = logger;\n\n    this.server = express();\n    this.server.use(bodyParser.json());\n\n    this.events = new EventEmitter();\n\n    this.notifications = [];\n\n    this.apiModules = [\n      new PresetsModule(this),\n      new TestControllerModule(this),\n    ];\n  }\n\n  /**\n   * Initializes the server and its modules\n   *\n   * @return {Promise.<*>}\n   */\n  init() {\n    const initializers = [];\n    for (const apiModule of this.apiModules) {\n      initializers.push(apiModule.init());\n    }\n\n    return Promise.all(initializers).then(() => {\n      this.setupRoutes();\n      this.stationManager.events.on('notification', this.onNotification.bind(this));\n    });\n  }\n\n  /**\n   * Sets up HTTP server routes / API entry points\n   */\n  setupRoutes() {\n    // getStations long poll handler\n    this.stationsLongPoll = new LongPollHandler(this.nconf.get('long_poll_timeout'));\n    this.stationManager.events.on('stationUpdate', () => {\n      this.stationsLongPoll.signalUpdate();\n    });\n    this.stationsLongPoll.events.on('wait', () => {\n      this.events.emit('longPollWait');\n    });\n    this.stationsLongPoll.events.on('timeout', () => {\n      this.events.emit('longPollTimeout');\n    });\n\n    const router = express.Router(); // eslint-disable-line new-cap\n    router.get('/applications', this.getApplications.bind(this));\n    router.get('/station_profiles', this.getStationProfiles.bind(this));\n    router.get('/stations', this.getStations.bind(this));\n    router.post('/stations/start', validate(HttpAPIServer.postStationsStartSchema()), this.postStationsStart.bind(this));\n    router.post('/stations/stop', validate(HttpAPIServer.postStationsStopSchema()), this.postStationsStop.bind(this));\n    router.post('/stations/change_app', validate(HttpAPIServer.postStationsChangeAppSchema()), this.postStationsChangeApp.bind(this));\n    router.get('/station/:id/output', validate(HttpAPIServer.getStationOutputSchema()), this.getStationOutput.bind(this));\n    router.get('/server/output', this.getServerOutput.bind(this));\n    router.get('/server/mklivestatus', this.getServerMKLivestatus.bind(this));\n    router.get('/notifications', this.getNotifications.bind(this));\n\n    this.server.use(router);\n\n    for (const apiModule of this.apiModules) {\n      const moduleRouter = express.Router(); // eslint-disable-line new-cap\n      apiModule.setupRoutes(moduleRouter);\n      this.server.use(moduleRouter);\n    }\n  }\n\n  /**\n   * Event handler for notifications from the StationManager\n   *\n   * Notifications are added to a list associated with the long polling updateID in order to\n   * only send new notifications to users. The list is truncated to max_notifications.\n   *\n   * @param {object} notification\n   */\n  onNotification(notification) {\n    notification.updateID = this.stationsLongPoll.getNextUpdateID();\n    this.notifications.push(notification);\n    const maxNotifications = this.nconf.get('max_notifications');\n    if (this.notifications.length > maxNotifications) {\n      this.notifications = this.notifications.slice(this.notifications.length - maxNotifications);\n    }\n\n    this.stationsLongPoll.signalUpdate();\n  }\n\n  /**\n   * Return stored notifications\n   *\n   * Each notification is an object with the following structure:\n   *  - id {string} : Unique id of the entry\n   *  - updateID {number} : Long polling update ID after which the notification was generated\n   *  - time {string} : Timestamp in ISO format\n   *  - type {string} : info | warning | error\n   *  - message {string} : Event description\n   *\n   * @param {number} lastUpdateID\n   *  Last seen update. Only notifications created after this updateID are sent.\n   * @returns {Array}\n   */\n  getLatestNotifications(lastUpdateID = 0) {\n    return this.notifications.filter(n => n.updateID > lastUpdateID);\n  }\n\n  /**\n   * GET /applications handler\n   * @param req\n   * @param res\n   */\n  getApplications(req, res) {\n    const applications = Array.from(this.stationManager.getApplications())\n      .map(a => a.toJSON())\n      .sort((a, b) => {\n        if (a.name < b.name) {\n          return -1;\n        } else if (a.name > b.name) {\n          return 1;\n        }\n        return 0;\n      });\n    res.json({\n      applications,\n    });\n  }\n\n  /**\n   * GET /station_profiles handler\n   * @param req\n   * @param res\n   */\n  getStationProfiles(req, res) {\n    const stationProfiles = Array.from(this.stationManager.getStationProfiles())\n      .map(a => a.toJSON())\n      .sort((a, b) => {\n        if (a.name < b.name) {\n          return -1;\n        } else if (a.name > b.name) {\n          return 1;\n        }\n        return 0;\n      });\n    res.json({\n      stationProfiles,\n    });\n  }\n\n  /**\n   * GET /stations handler\n   * @param req\n   * @param res\n   */\n  getStations(req, res) {\n    this.stationsLongPoll.handleRequest(req)\n      .then((updateID) => {\n        const stations = this.stationManager.getStations().map(s => s.toJSON());\n        for (const station of stations) {\n          station.icon = HttpAPIServer.getIconURL(station.app);\n        }\n        const lastUpdateID = parseInt(req.query.lastUpdateID, 10) || 0;\n        res.json({\n          updateID,\n          stations,\n          notifications: lastUpdateID !== 0 ? this.getLatestNotifications(lastUpdateID) : [],\n        });\n      })\n      .catch(() => {\n        res.json({});\n      });\n  }\n\n  /**\n   * POST /stations/start handler\n   * @param req\n   * @param res\n   */\n  postStationsStart(req, res) {\n    if (!req.body.ids) {\n      this.logger.debug(\"HTTP request received: Start stations missing required 'ids' argument\");\n      res.status(400).send(\"Missing 'ids' argument\");\n      return;\n    }\n    this.logger.debug(`HTTP request received: Start stations ${req.body.ids}`);\n    this.stationManager.startStations(req.body.ids);\n    res.json({});\n  }\n\n  /**\n   * POST /stations/stop handler\n   * @param req\n   * @param res\n   */\n  postStationsStop(req, res) {\n    if (!req.body.ids) {\n      this.logger.debug(\"HTTP request received: Stop stations missing required 'ids' argument\");\n      res.status(400).send(\"Missing 'ids' argument\");\n      return;\n    }\n    this.logger.debug(`HTTP request received: Stop stations ${req.body.ids}`);\n    this.stationManager.stopStations(req.body.ids);\n    res.json({});\n  }\n\n  /**\n   * POST /stations/change_app handler\n   * @param req\n   * @param res\n   */\n  postStationsChangeApp(req, res) {\n    if (!req.body.ids) {\n      this.logger.debug(\"HTTP request received: Change app missing required 'ids' argument\");\n      res.status(400).send(\"Missing 'ids' argument\");\n      return;\n    }\n    if (!req.body.app) {\n      this.logger.debug(\"HTTP request received: Change app missing required 'app' argument\");\n      res.status(400).send(\"Missing 'app' argument\");\n      return;\n    }\n    this.logger.debug(\n      `HTTP request received: Change app of stations ${req.body.ids} to ${req.body.app}`);\n    this.stationManager.changeApp(req.body.ids, req.body.app);\n    res.json({});\n  }\n\n  /**\n   * GET /station/:id/output handler\n   * @param req\n   * @param res\n   */\n  getStationOutput(req, res) {\n    this.logger.debug(`HTTP request received: Get output of station ${req.params.id}`);\n    const station = this.stationManager.getStationByID(req.params.id);\n    if (station) {\n      res.json({\n        lines: station.outputBuffer.getAll(),\n      });\n    } else {\n      this.logger.error(`Requested output of non existant station ${req.params.id}`);\n      res.status(404).send('Station not found');\n    }\n  }\n\n  /**\n   * GET /server/output handler\n   * @param req\n   * @param res\n   */\n  getServerOutput(req, res) {\n    this.logger.debug('HTTP request received: Get global output');\n    res.json({\n      lines: this.stationManager.globalHilbertCLIOutputBuffer.getAll(),\n    });\n  }\n\n  /**\n   * GET /server/mklivestatus handler\n   * @param req\n   * @param res\n   */\n  getServerMKLivestatus(req, res) {\n    this.logger.debug('HTTP request received: Get last MKLivestatus state');\n    res.json({\n      lastState: this.stationManager.lastMKLivestatusDump,\n    });\n  }\n\n  /**\n   * GET /notifications handler\n   * @param req\n   * @param res\n   */\n  getNotifications(req, res) {\n    this.logger.debug('HTTP request received: Get notifications');\n    res.json({\n      notifications: this.getLatestNotifications(),\n    });\n  }\n\n  getServer() {\n    return this.server;\n  }\n\n  /**\n   * Return the URL of the icon of the specified app\n   *\n   * @param {string} appID - ID of the app\n   * @returns {string} - URL of the icon\n   */\n  static getIconURL(appID) {\n    if (iconmap[appID] !== undefined) {\n      return `icons/${iconmap[appID]}`;\n    }\n    return 'icons/none.png';\n  }\n\n  /**\n   * Start listening for requests on a port\n   *\n   * @param port\n   */\n  listen(port) {\n    this.server.listen(port);\n    this.logger.info(`Server listening on port ${port}.`);\n  }\n\n  static postStationsStartSchema() {\n    return {\n      body: {\n        ids: Joi.array().items(Joi.string()).required(),\n      },\n    };\n  }\n\n  static postStationsStopSchema() {\n    return {\n      body: {\n        ids: Joi.array().items(Joi.string()).required(),\n      },\n    };\n  }\n\n  static postStationsChangeAppSchema() {\n    return {\n      body: {\n        ids: Joi.array().items(Joi.string()).required(),\n      },\n      app: Joi.string().required(),\n    };\n  }\n\n  static getStationOutputSchema() {\n    return {\n      params: {\n        id: Joi.string().required(),\n      },\n    };\n  }\n}\n"],"sourceRoot":"/source/"}