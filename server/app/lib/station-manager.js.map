{"version":3,"sources":["lib/station-manager.js"],"names":[],"mappings":"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","file":"lib/station-manager.js","sourcesContent":["const iconmap = require('../../iconmap.json');\nconst EventEmitter = require('events').EventEmitter;\n\nimport Station from './station';\n\n/**\n * Service Layer to the DockApp system\n * Dispatches requests asynchronously and keeps cached state\n */\nexport default class StationManager {\n\n  /**\n   * Create a Station Manager\n   *\n   * @param {Object} config - Instance of nconf configuration\n   * @param {Object} logger - Instance of winston logger\n   * @param {DockAppConnector} connector - DockApp connector\n   */\n  constructor(config, logger, connector) {\n    this.config = config;\n    this.logger = logger;\n    this.connector = connector;\n    this.events = new EventEmitter();\n    this.logEntries = [];\n    this.lastLogID = 1;\n\n    this.loadStationConfig();\n  }\n\n  /**\n   * Loads the station configuration.\n   *\n   * If the configuration was already loaded this method clears it\n   * and reloads everything\n   */\n  loadStationConfig() {\n    this.clearStations();\n    this.signalUpdate();\n\n    this.connector.getStationConfig().then((stationsCFG) => {\n      for (const stationCFG of stationsCFG) {\n        const newStation = new Station(stationCFG);\n        newStation.icon = StationManager.getIconURL(newStation.app);\n        this.addStation(newStation);\n      }\n      this.signalUpdate();\n    }).catch((error) => {\n      this.logger.error(error);\n    });\n  }\n\n  /**\n   * Adds a station to the manager\n   * @param {Station} aStation\n   */\n  addStation(aStation) {\n    this.stationList.push(aStation);\n    this.stationIndex.set(aStation.id, aStation);\n  }\n\n  /**\n   * Removes a station from the manager\n   * @param {Station} aStation\n   */\n  removeStation(aStation) {\n    const i = this.stationList.indexOf(aStation);\n    if (i !== -1) {\n      this.stationList.splice(i, 1);\n    }\n\n    this.stationIndex.delete(aStation.id);\n  }\n\n  /**\n   * Removes all the stations\n   */\n  clearStations() {\n    this.stationIndex = new Map();\n    this.stationList = [];\n  }\n\n  /**\n   * Get the ordered list of stations\n   * @returns {Array}\n   */\n  getStations() {\n    return this.stationList;\n  }\n\n  /**\n   * Return a station identified by ID\n   *\n   * @param {string} id - Station ID\n   * @returns {Station}\n   */\n  getStationByID(id) {\n    return this.stationIndex.get(id);\n  }\n\n  /**\n   * Start indicated stations\n   *\n   * @todo Change interface to return a promise\n   * @param {Iterable} stationIDs - IDs of stations to start\n   */\n  startStations(stationIDs) {\n    for (const stationID of stationIDs) {\n      const station = this.getStationByID(stationID);\n      if (station) {\n        if (station.state === Station.OFF) {\n          station.state = Station.BUSY;\n          station.status = 'Starting...';\n          this.connector.startStation(stationID).then(() => {\n            station.state = Station.ON;\n            station.status = '';\n            this.log('message', station, 'Station started');\n          })\n          .catch(() => {\n            station.state = Station.ERROR;\n            station.status = 'Failure starting the station';\n            this.log('error', station, 'Error starting station');\n          })\n          .then(() => {\n            this.signalUpdate();\n          });\n        }\n      }\n    }\n    this.signalUpdate();\n  }\n\n  /**\n   * Stop indicated stations\n   *\n   * @todo Change interface to return a promise\n   * @param {Iterable} stationIDs - IDs of stations to stop\n   */\n  stopStations(stationIDs) {\n    for (const stationID of stationIDs) {\n      const station = this.getStationByID(stationID);\n      if (station) {\n        if (station.state === Station.ON) {\n          station.state = Station.BUSY;\n          station.status = 'Stopping...';\n\n          this.connector.stopStation(stationID).then(() => {\n            station.state = Station.OFF;\n            station.status = '';\n            this.log('message', station, 'Station stopped');\n          })\n          .catch(() => {\n            station.state = Station.ERROR;\n            station.status = 'Failure stopping the station';\n            this.log('error', station, 'Error stopping station');\n          })\n          .then(() => {\n            this.signalUpdate();\n          });\n        }\n      }\n    }\n    this.signalUpdate();\n  }\n\n  /**\n   * Change the application running in indicated stations\n   *\n   * @todo Change interface to return a promise\n   * @param {iterable} stationIDs - IDs of stations in which to change the appID\n   * @param {string} appID - Name of the appID to run\n   */\n  changeApp(stationIDs, appID) {\n    for (const stationID of stationIDs) {\n      const station = this.getStationByID(stationID);\n      if (station) {\n        if (station.state === Station.ON) {\n          station.state = Station.BUSY;\n          station.status = `Switching to ${appID}...`;\n          station.app = '';\n\n          this.connector.changeApp(stationID, appID).then(() => {\n            station.app = appID;\n            station.icon = StationManager.getIconURL(appID);\n            station.state = Station.ON;\n            station.status = '';\n            this.log('message', station, `Launched app ${appID}`);\n          })\n          .catch(() => {\n            station.app = appID;\n            station.icon = StationManager.getIconURL(appID);\n            station.state = Station.ERROR;\n            station.status = 'Failure launching app';\n            this.log('error', station, `Failed to launch app ${appID}`);\n          })\n          .then(() => {\n            this.signalUpdate();\n          });\n        }\n      }\n    }\n    this.signalUpdate();\n  }\n\n  /**\n   * Return the URL of the icon of the specified app\n   *\n   * @param {string} appID - ID of the app\n   * @returns {string} - URL of the icon\n   */\n  static getIconURL(appID) {\n    if (iconmap[appID] !== undefined) {\n      return `icons/${iconmap[appID]}`;\n    }\n    return 'icons/none.png';\n  }\n\n  /**\n   * Return the station activity log\n   *\n   * Each log entry is an object with the following structure:\n   * - id {string} : Unique id of the entry\n   * - time {string} : Timestamp in ISO format\n   * - type {string} : info | warning | error\n   * - message {string} : Event description\n   *\n   * @returns {Array}\n   */\n  getLog() {\n    return this.logEntries;\n  }\n\n\n  /**\n   * Logs an event\n   *\n   * @param {string} type - Event type: info | warning | error\n   * @param {Station|null} station - station associated with the event logged\n   * @param {string} message - Message to log\n   */\n  log(type, station, message) {\n    const newLogEntry = {\n      id: this.lastLogID,\n      time: new Date().toISOString(),\n      type,\n      message,\n    };\n\n    if (station !== null) {\n      newLogEntry.station_id = station.id;\n      newLogEntry.station_name = station.name;\n    }\n\n    this.lastLogID++;\n    this.logEntries.push(newLogEntry);\n\n    const maxEntries = this.config.get('max_log_length');\n    if (this.logEntries.length > maxEntries) {\n      this.logEntries = this.logEntries.slice(this.logEntries.length - maxEntries);\n    }\n  }\n  \n  /**\n   * Signal listeners that station data was modified\n   * @private\n   */\n  signalUpdate() {\n    this.events.emit('stationUpdate');\n  }\n}\n"],"sourceRoot":"/source/"}