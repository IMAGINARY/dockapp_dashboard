{"version":3,"sources":["lib/mk-livestatus-query.js"],"names":[],"mappings":";;;;;;;;;;AAAA,IAAM,UAAU,QAAQ,UAAR,CAAhB;;;;;;;IAMqB,iB;;;;;;;AAMnB,6BAAY,SAAZ,EAAuB;AAAA;;AACrB,SAAK,gBAAL,GAAwB,SAAxB;AACA,SAAK,SAAL,GAAiB,IAAjB;AACA,SAAK,YAAL,GAAoB,EAApB;AACA,SAAK,kBAAL,GAA0B,IAA1B;AACA,SAAK,YAAL,GAAoB,EAApB;AACD;;;;;;;;;;;wBAOG,S,EAAW;AACb,WAAK,SAAL,GAAiB,SAAjB;AACA,aAAO,IAAP;AACD;;;;;;;;;;;;;;4BAWO,U,EAAY;AAClB,WAAK,YAAL,GAAoB,KAAK,YAAL,CAAkB,MAAlB,CAAyB,UAAzB,CAApB;;AAEA,aAAO,IAAP;AACD;;;;;;;;;;;;8BASS,a,EAAe;AACvB,WAAK,kBAAL,GAA0B,aAA1B;;AAEA,aAAO,IAAP;AACD;;;;;;;;;;;;;2BAUM,S,EAAW;AAChB,WAAK,YAAL,CAAkB,IAAlB,CAAuB,SAAvB;;AAEA,aAAO,IAAP;AACD;;;;;;;;;+BAMU;AACT,UAAM,SAAS,EAAf;AACA,aAAO,IAAP,UAAmB,KAAK,SAAxB;;AAEA,UAAI,KAAK,YAAL,CAAkB,MAAlB,GAA2B,CAA/B,EAAkC;AAChC,eAAO,IAAP,eAAwB,KAAK,YAAL,CAAkB,IAAlB,CAAuB,GAAvB,CAAxB;AACD;;AANQ;AAAA;AAAA;;AAAA;AAQT,6BAAqB,KAAK,YAA1B,8HAAwC;AAAA,cAA7B,MAA6B;;AACtC,iBAAO,IAAP,cAAuB,MAAvB;AACD;AAVQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAYT,aAAO,IAAP,CAAY,oBAAZ;AACA,aAAO,IAAP,CAAY,mBAAZ;;AAEA,aAAO,OAAO,IAAP,CAAY,IAAZ,CAAP;AACD;;;;;;;;;;;8BAQS;AAAA;;AACR,aAAO,KAAK,gBAAL,CAAsB,WAAtB,CAAkC,KAAK,QAAL,EAAlC,EAAmD,IAAnD,CAAwD,UAAC,MAAD,EAAY;AACzE,eAAO,MAAK,aAAL,CAAmB,KAAK,KAAL,CAAW,MAAX,CAAnB,CAAP;AACD,OAFM,CAAP;AAGD;;;;;;;;;;;;;kCAWa,I,EAAM;AAClB,UAAI,KAAK,MAAL,GAAc,CAAlB,EAAqB;AACnB,eAAO,IAAP;AACD;;AAED,UAAM,WAAW,KAAK,KAAL,CAAW,CAAX,EAAc,CAAd,EAAiB,CAAjB,CAAjB;AACA,UAAM,UAAU,KAAK,kBAAL,KAA4B,IAA5B,GAAmC,KAAK,kBAAxC,GAA6D,QAA7E;;AAEA,UAAM,OAAO,KAAK,KAAL,CAAW,CAAX,CAAb;AACA,UAAM,UAAU,EAAhB;AATkB;AAAA;AAAA;;AAAA;AAUlB,8BAAkB,IAAlB,mIAAwB;AAAA,cAAb,GAAa;;AACtB,cAAM,YAAY,EAAlB;AACA,eAAK,IAAI,IAAI,CAAb,EAAiB,MAAM,QAAQ,MAAf,IAA2B,IAAI,GAA/C,EAAqD,GAArD,EAA0D;AACxD,sBAAU,QAAQ,CAAR,CAAV,IAAwB,IAAI,CAAJ,CAAxB;AACD;AACD,kBAAQ,IAAR,CAAa,SAAb;AACD;AAhBiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAiBlB,aAAO,OAAP;AACD;;;;;;kBA/HkB,iB","file":"lib/mk-livestatus-query.js","sourcesContent":["const Promise = require(\"bluebird\");\n/**\n * Generates MK Livestatus queries\n *\n * http://mathias-kettner.com/checkmk_livestatus.html\n */\nexport default class MKLivestatusQuery {\n\n  /**\n   * Constructor\n   * @param {MKLivestatusConnector} connector\n   */\n  constructor(connector) {\n    this.dockAppConnector = connector;\n    this.tableName = null;\n    this.queryColumns = [];\n    this.queryColumnAliases = null;\n    this.queryFilters = [];\n  }\n\n  /**\n   * Inits a GET query\n   * @param {String} tableName\n   * @returns {MKLivestatusQuery}\n   */\n  get(tableName) {\n    this.tableName = tableName;\n    return this;\n  }\n\n  /**\n   * Specifies columns to return\n   *\n   * If this method is never called the query will return all columns\n   * If it's called several times the columns will be added\n   *\n   * @param {Array|String} columnList\n   * @returns {MKLivestatusQuery}\n   */\n  columns(columnList) {\n    this.queryColumns = this.queryColumns.concat(columnList);\n\n    return this;\n  }\n\n  /**\n   * Specifies aliases to column names\n   *\n   * An array with one alias per queries columned must be provided.\n   * @param {Array} columnAliases\n   * @returns {MKLivestatusQuery}\n   */\n  asColumns(columnAliases) {\n    this.queryColumnAliases = columnAliases;\n\n    return this;\n  }\n\n  /**\n   * Adds a filter condition\n   *\n   * This class does not yet support disjunctions (OR)\n   *\n   * @param {String} condition\n   * @returns {MKLivestatusQuery}\n   */\n  filter(condition) {\n    this.queryFilters.push(condition);\n\n    return this;\n  }\n\n  /**\n   * Converts the query to a string command\n   * @returns {string}\n   */\n  toString() {\n    const output = [];\n    output.push(`GET ${this.tableName}`);\n\n    if (this.queryColumns.length > 0) {\n      output.push(`Columns: ${this.queryColumns.join(' ')}`);\n    }\n\n    for (const filter of this.queryFilters) {\n      output.push(`Filter: ${filter}`);\n    }\n\n    output.push('OutputFormat: json');\n    output.push('ColumnHeaders: on');\n\n    return output.join('\\n');\n  }\n\n  /**\n   * Executes the query\n   * @returns {Promise}\n   * @resolve {Array} Response rows\n   * @reject {Error}\n   */\n  execute() {\n    return this.dockAppConnector.sendCommand(this.toString()).then((answer) => {\n      return this.rowsToObjects(JSON.parse(answer));\n    });\n  }\n\n\n  /**\n   * Converts an array of row arrays to an array of objects\n   * Uses the first row as a list of names.\n   * @private\n   *\n   * @param rows {Array}\n   * @returns {Array}\n   */\n  rowsToObjects(rows) {\n    if (rows.length < 2) {\n      return rows;\n    }\n\n    const firstRow = rows.slice(0, 1)[0];\n    const nameRow = this.queryColumnAliases !== null ? this.queryColumnAliases : firstRow;\n\n    const rest = rows.slice(1);\n    const objects = [];\n    for (const row of rest) {\n      const rowObject = {};\n      for (let i = 0; (i !== nameRow.length) && (i < 100); i++) {\n        rowObject[nameRow[i]] = row[i];\n      }\n      objects.push(rowObject);\n    }\n    return objects;\n  }\n}\n"],"sourceRoot":"/source/"}