{"version":3,"sources":["lib/station.js"],"names":[],"mappings":"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","file":"lib/station.js","sourcesContent":["import StationOutputBuffer from './station-output-buffer';\nimport Nagios from './nagios';\n\nexport default class Station {\n\n  constructor(config) {\n    const configKeys = ['id', 'name', 'type', 'default_app', 'possible_apps'];\n\n    for (const configKey of configKeys) {\n      if (!config.hasOwnProperty(configKey)) {\n        if (configKey === 'id') {\n          throw new Error('Attempted to initialize station with config missing id');\n        }\n        throw new Error(\n          `Attempted to initialize station ${config.id} missing config key ${configKey}`\n        );\n      }\n\n      this[configKey] = config[configKey];\n    }\n\n    this.state = Station.UNKNOWN;\n    this.status = '';\n    this.app = this.default_app;\n    this.switching_app = '';\n    this.outputBuffer = new StationOutputBuffer();\n  }\n\n  /**\n   * Updates the state of the station\n   *\n   * Returns true if the state was changed\n   *\n   * @param {Object} stationStatus - MKLivestatus status of the station\n   * @returns {boolean}\n   */\n  updateFromMKLivestatus(stationStatus) {\n    // stationStatus:\n      // id: station.id,\n      // state: Nagios.HostState.DOWN,\n      // state_type: Nagios.StateType.HARD,\n      // app_state: Nagios.ServiceState.UNKNOWN,\n      // app_state_type: Nagios.StateType.HARD,\n      // app_id: '',\n\n    let changes = false;\n    if (this.app !== stationStatus.app_id) {\n      this.app = stationStatus.app_id;\n      changes = true;\n    }\n\n    // todo: STARTING and STOPPING timeout\n    // todo: SWITCHING_APP timeout\n\n    if (this.state === Station.ERROR) {\n      return false;\n    }\n\n    if (stationStatus.state === Nagios.HostState.UNREACHABLE) {\n      this.state = Station.ERROR;\n      this.status = 'Station unreachable';\n      return true;\n    }\n\n    if ((this.state === Station.UNKNOWN)) {\n      if (stationStatus.state === Nagios.HostState.DOWN) {\n        this.state = Station.OFF;\n        this.status = '';\n        return true;\n      } else if (stationStatus.state === Nagios.HostState.UP) {\n        this.state = Station.ON;\n        this.status = '';\n        return true;\n      }\n    } else if (this.state === Station.ON) {\n      if (stationStatus.state === Nagios.HostState.DOWN) {\n        this.state = Station.OFF;\n        this.status = '';\n        return true;\n      }\n    } else if (this.state === Station.OFF) {\n      if (stationStatus.state === Nagios.HostState.UP) {\n        console.log('changing');\n        this.state = Station.ON;\n        this.status = '';\n        return true;\n      }\n    } else if (this.state === Station.STOPPING) {\n      if (stationStatus.state === Nagios.HostState.DOWN) {\n        this.state = Station.OFF;\n        this.status = '';\n        return true;\n      }\n    } else if (this.state === Station.STARTING) {\n      if (stationStatus.state === Nagios.HostState.UP) {\n        this.state = Station.ON;\n        this.status = '';\n        return true;\n      }\n    } else if (this.state === Station.SWITCHING_APP) {\n      if (this.switching_app !== '' && this.switching_app === stationStatus.app_id) {\n        this.state = Station.ON;\n        this.status = '';\n        this.switching_app = '';\n      }\n\n      if (stationStatus.state === Nagios.HostState.DOWN) {\n        this.state = Station.OFF;\n        this.status = '';\n        return true;\n      }\n    }\n\n    return changes;\n  }\n}\n\n// Station states\n\nStation.UNKNOWN = 'unk';\nStation.OFF = 'off';\nStation.ON = 'on';\nStation.STOPPING = 'stopping';\nStation.STARTING = 'starting';\nStation.SWITCHING_APP = 'switching_app';\nStation.ERROR = 'error';\n"],"sourceRoot":"/source/"}