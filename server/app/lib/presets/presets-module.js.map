{"version":3,"sources":["lib/presets/presets-module.js"],"names":["validate","require","Joi","PresetsModule","httpApiServer","stationManager","logger","nconf","presetStore","info","open","get","router","getAllPresets","bind","post","addPresetSchema","addPreset","getPresetSchema","getPreset","put","updatePresetSchema","updatePreset","delete","deletePresetSchema","deletePreset","activatePresetSchema","activatePreset","req","res","loadAllPresets","then","allPresets","jsonPresets","preset","push","toJSON","json","presets","catch","err","status","error","message","loadPreset","params","id","send","newPreset","createPreset","body","save","name","stationApps","Object","assign","remove","Promise","resolve","entries","stationID","appID","changeApp","number","min","max","MAX_ID","required","presetIdParamSchema","string","MAX_NAME_LEN","object","pattern"],"mappings":"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","file":"lib/presets/presets-module.js","sourcesContent":["import Preset from './preset';\nimport PresetStore from './preset-store';\nimport DuplicateIdentifierError from './duplicate-identifier-error';\n\nconst validate = require('express-validation');\nconst Joi = require('joi');\n/**\n * Module that adds supports for Presets to the HTTP Api Server\n */\nexport default class PresetsModule {\n\n  constructor(httpApiServer) {\n    this.httpApiServer = httpApiServer;\n    this.stationManager = this.httpApiServer.stationManager;\n    this.logger = this.httpApiServer.logger;\n    this.nconf = this.httpApiServer.nconf;\n    this.presetStore = new PresetStore();\n  }\n\n  init() {\n    this.logger.info('Initializing Presets module');\n    return this.presetStore.open(this.nconf.get('db_path'));\n  }\n\n  setupRoutes(router) {\n    router.get('/presets', this.getAllPresets.bind(this));\n    router.post('/preset', validate(PresetsModule.addPresetSchema()), this.addPreset.bind(this));\n    router.get('/preset/:id', validate(PresetsModule.getPresetSchema()), this.getPreset.bind(this));\n    router.put('/preset/:id', validate(PresetsModule.updatePresetSchema()), this.updatePreset.bind(this));\n    router.delete('/preset/:id', validate(PresetsModule.deletePresetSchema()), this.deletePreset.bind(this));\n    router.post('/preset/:id/activate', validate(PresetsModule.activatePresetSchema()), this.activatePreset.bind(this));\n  }\n\n  getAllPresets(req, res) {\n    this.presetStore.loadAllPresets().then(\n      (allPresets) => {\n        const jsonPresets = [];\n        for (const preset of allPresets) {\n          jsonPresets.push(preset.toJSON());\n        }\n        res.json({\n          presets: jsonPresets,\n        });\n      }\n    ).catch((err) => {\n      res.status(500).json({ error: err.message });\n    });\n  }\n\n  getPreset(req, res) {\n    this.presetStore.loadPreset(req.params.id).then(\n      (preset) => {\n        if (preset === null) {\n          res.status(404).send('Preset not found');\n        } else {\n          res.json(preset.toJSON());\n        }\n      }\n    ).catch((err) => {\n      res.status(500).json({ error: err.message });\n    });\n  }\n\n  addPreset(req, res) {\n    const newPreset = this.presetStore.createPreset(req.body);\n    newPreset.save()\n    .then((preset) => {\n      res.json(preset.toJSON());\n    })\n    .catch((err) => {\n      if (err instanceof DuplicateIdentifierError) {\n        res.status(400).json({ error: err.message });\n      } else {\n        res.status(500).json({ error: err.message });\n      }\n    });\n  }\n\n  updatePreset(req, res) {\n    this.presetStore.loadPreset(req.params.id).then(\n      (preset) => {\n        if (preset === null) {\n          res.status(404).send('Preset not found');\n        } else {\n          if (req.body.name) {\n            preset.name = req.body.name;\n          }\n          if (req.body.stationApps) {\n            preset.stationApps = Object.assign({}, req.body.stationApps);\n          }\n          preset.save()\n          .then(() => {\n            res.json(preset.toJSON());\n          })\n          .catch((err) => {\n            if (err instanceof DuplicateIdentifierError) {\n              res.status(400).json({ error: err.message });\n            } else {\n              res.status(500).json({ error: err.message });\n            }\n          });\n        }\n      }\n    ).catch((err) => {\n      res.status(500).json({ error: err.message });\n    });\n  }\n\n  deletePreset(req, res) {\n    this.presetStore.loadPreset(req.params.id).then(\n      (preset) => {\n        if (preset === null) {\n          res.status(404).send('Preset not found');\n        } else {\n          return preset.remove()\n          .then(() => {\n            res.status(200).send('');\n          });\n        }\n        return Promise.resolve();\n      }\n    ).catch((err) => {\n      res.status(500).json({ error: err.message });\n    });\n  }\n\n  activatePreset(req, res) {\n    this.presetStore.loadPreset(req.params.id).then(\n      (preset) => {\n        if (preset === null) {\n          res.status(404).send('Preset not found');\n        } else {\n          for (const [stationID, appID] of Object.entries(preset.stationApps)) {\n            this.stationManager.changeApp([stationID], appID);\n          }\n          res.status(200).send('');\n        }\n      }\n    ).catch((err) => {\n      res.status(500).json({ error: err.message });\n    });\n  }\n\n  static presetIdParamSchema() {\n    return {\n      params: {\n        id: Joi.number().min(1).max(Preset.MAX_ID).required(),\n      },\n    };\n  }\n\n  static getPresetSchema() {\n    return PresetsModule.presetIdParamSchema();\n  }\n\n  static addPresetSchema() {\n    return {\n      body: {\n        name: Joi.string().min(1).max(Preset.MAX_NAME_LEN).required(),\n        stationApps: Joi.object().pattern(/./, Joi.string().min(1)).required(),\n      },\n    };\n  }\n\n  static updatePresetSchema() {\n    return Object.assign(PresetsModule.presetIdParamSchema(), {\n      body: {\n        name: Joi.string().min(1).max(Preset.MAX_NAME_LEN),\n        stationApps: Joi.object().pattern(/./, Joi.string().min(1)),\n      },\n    });\n  }\n\n  static deletePresetSchema() {\n    return PresetsModule.presetIdParamSchema();\n  }\n\n  static activatePresetSchema() {\n    return PresetsModule.presetIdParamSchema();\n  }\n}\n"],"sourceRoot":"/source/"}