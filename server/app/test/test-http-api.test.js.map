{"version":3,"sources":["test/test-http-api.test.js"],"names":["request","require","logger","nconf","testCfgA","describe","apiServer","before","done","defaults","port","test","scriptConcurrency","max_notifications","log_directory","log_level","mkls_poll_delay","mkls_cmd","long_poll_timeout","operation_timeout","error_lock_time","db_path","testBackend","load","stationManager","getHilbertCLIConnector","getMKLivestatusConnector","init","then","httpAPIServer","getServer","it","get","set","expect","post","send","ids","app"],"mappings":"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","file":"test/test-http-api.test.js","sourcesContent":["import StationManager from '../lib/station-manager';\nimport HttpAPIServer from '../lib/http-api-server';\nimport TestBackend from '../lib/test-backend/test-backend';\n\nconst request = require('supertest');\nconst logger = require('winston');\nconst nconf = require('nconf');\n\nconst testCfgA = require('../../data/test_mode/test_cfg_a.json');\n\ndescribe('HTTP API', () => {\n  let apiServer = null;\n\n  before((done) => {\n    nconf.defaults({\n      port: '3000',\n      test: true,\n      scriptConcurrency: 20,\n      max_notifications: 100,\n      log_directory: './log',\n      log_level: 'info', // error, warn, info, verbose, debug, silly\n      mkls_poll_delay: 1000,\n      mkls_cmd: 'nc localhost 6557',\n      long_poll_timeout: 0,\n      operation_timeout: 10,\n      error_lock_time: 10,\n      db_path: '',\n    });\n\n    const testBackend = new TestBackend(nconf, logger);\n    testBackend.load(testCfgA);\n    const stationManager = new StationManager(\n      nconf,\n      logger,\n      testBackend.getHilbertCLIConnector(),\n      testBackend.getMKLivestatusConnector()\n    );\n\n    stationManager.init().then(() => {\n      const httpAPIServer = new HttpAPIServer(stationManager, nconf, logger);\n      httpAPIServer.init().then(() => {\n        apiServer = httpAPIServer.getServer();\n        done();\n      });\n    });\n  });\n\n  describe('GET /stations', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/stations')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('POST /stations/start', () => {\n    it('fails with no arguments', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .set('Accept', 'application/json')\n        .expect(400, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .send({ ids: ['station_interactive_1'] })\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('POST /stations/stop', () => {\n    it('fails with no arguments', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .set('Accept', 'application/json')\n        .expect(400, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .post('/stations/stop')\n        .send({ ids: ['station_interactive_1'] })\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('POST /stations/change_app', () => {\n    it('fails with no arguments', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .set('Accept', 'application/json')\n        .expect(400, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .post('/stations/change_app')\n        .send({ ids: ['station_a'] })\n        .send({ app: 'app_b' })\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /station/:id/output', () => {\n    it('fails if the station does not exist', (done) => {\n      request(apiServer)\n        .get('/station/station_x/output')\n        .set('Accept', 'application/json')\n        .expect(404, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/station/station_a/output')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /server/output', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/server/output')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /server/mklivestatus', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/server/mklivestatus')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /notifications', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/notifications')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /applications', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/applications')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /station_profiles', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/station_profiles')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n});\n"],"sourceRoot":"/source/"}