{"version":3,"sources":["main.js"],"names":[],"mappings":"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","file":"main.js","sourcesContent":["const appPackage = require('../package.json');\nconst logger = require('winston');\nconst nconf = require('nconf');\nconst express = require('express');\nconst app = express();\nconst bodyParser = require('body-parser');\nconst EventEmitter = require('events').EventEmitter;\n\nimport StationManager from './lib/station-manager';\nimport DockAppConnector from './lib/dockapp-connector';\nimport TestingConnector from './lib/testing-connector';\n\nprocess.on('uncaughtException', (err) => {\n  console.log(err);\n  process.exitCode = 1;\n});\n\napp.use(bodyParser.json());\n\nnconf.file('config.json');\nnconf.defaults({\n  port: '3000',\n  dockapp_path: '../work/dockapp',\n  test: false,\n  max_log_length: 100,\n  log_directory: './log',\n  log_level: 'info', // error, warn, info, verbose, debug, silly\n});\n\nlogger.add(logger.transports.File, {\n  filename: `${nconf.get('log_directory')}/dockapp_dashboard.log`,\n  level: nconf.get('log_level'),\n  handleExceptions: true,\n  json: false,\n});\n\nlogger.info(`Starting dockapp_dashboard server (v${appPackage.version})`);\n\nlet connector = null;\nif (nconf.get('test')) {\n  connector = new TestingConnector(nconf, logger);\n} else {\n  connector = new DockAppConnector(nconf, logger);\n}\n\nconst stationManager = new StationManager(nconf, logger, connector);\n\n// Longpoll begin\n\nconst pollUpdateEmitter = new EventEmitter();\npollUpdateEmitter.setMaxListeners(100);\nlet updateID = 1;\nconst pollTimeoutDelay = 15000;\n\nfunction respondJSON(res, data) {\n  res.writeHead(200, { 'Content-Type': 'application/json' });\n  res.end(JSON.stringify(data));\n}\n\nfunction stationDataResponse() {\n  return {\n    updateID,\n    stations: stationManager.getStations(),\n  };\n}\n\nfunction emptyResponse(req, res) {\n  return {};\n}\n\napp.get('/poll.json', (req, res) => {\n  // if the client is out of sync respond immediately\n  if (Number(req.query.lastSeen) !== updateID) {\n    respondJSON(res, stationDataResponse());\n  } else {\n    // ... otherwise wait for an update to respond\n\n    // On timeout send an empty update\n    const pollTimeout = setTimeout(() => {\n      pollUpdateEmitter.emit('update', emptyResponse());\n    }, pollTimeoutDelay);\n\n    // If there was an update respond\n    pollUpdateEmitter.once('update', (data) => {\n      clearTimeout(pollTimeout);\n      respondJSON(res, data);\n    });\n  }\n});\n\nstationManager.events.on('stationUpdate', () => {\n  updateID++;\n  pollUpdateEmitter.emit('update', stationDataResponse());\n});\n\n// Longpoll end\n\napp.get('/stations.json', (req, res) => {\n  respondJSON(res, stationDataResponse());\n});\n\napp.post('/stations.json', (req, res) => {\n  if (req.body.action === 'start') {\n    stationManager.startStations(req.body.stationIDs);\n    respondJSON(res, emptyResponse());\n  } else if (req.body.action === 'stop') {\n    stationManager.stopStations(req.body.stationIDs);\n    respondJSON(res, emptyResponse());\n  } else if (req.body.action === 'change_app') {\n    stationManager.changeApp(req.body.stationIDs, req.body.app);\n    respondJSON(res, emptyResponse());\n  } else {\n    res.writeHead(404, 'Action not found');\n    res.end();\n  }\n});\n\napp.get('/log.json', (req, res) => {\n  respondJSON(res, { entries: stationManager.getLog() });\n});\n\n// Spawn server\nconst port = nconf.get('port');\napp.listen(port);\nlogger.info(`Server listening on port ${port}.`);\n\n"],"sourceRoot":"/source/"}